@using SmashScheduler.Domain.Entities
@using SmashScheduler.Domain.Enums

<MudExpansionPanels Class="mb-4">
    <MudExpansionPanel Text="Session Statistics">
        <TitleContent>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Analytics" Color="Color.Primary" />
                <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Session Statistics</MudText>
                <MudChip T="string" Color="Color.Primary" Size="Size.Small" Variant="Variant.Text">
                    @GetInProgressCount() playing â€¢ @CompletedMatchCount completed
                </MudChip>
            </MudStack>
        </TitleContent>
        <ChildContent>
            <MudGrid Spacing="2" Class="mb-3">
                <MudItem xs="6" sm="3">
                    <MudPaper Class="pa-3 text-center" Elevation="0" Style="background-color: var(--mud-palette-primary-lighten);">
                        <MudText Typo="Typo.h5" Color="Color.Primary">@GetInProgressCount()</MudText>
                        <MudText Typo="Typo.caption">In Progress</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="6" sm="3">
                    <MudPaper Class="pa-3 text-center" Elevation="0" Style="background-color: var(--mud-palette-success-lighten);">
                        <MudText Typo="Typo.h5" Color="Color.Success">@CompletedMatchCount</MudText>
                        <MudText Typo="Typo.caption">Completed</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="6" sm="3">
                    <MudPaper Class="pa-3 text-center" Elevation="0" Style="background-color: var(--mud-palette-info-lighten);">
                        <MudText Typo="Typo.h5" Color="Color.Info">@AverageGamesPerPlayer.ToString("F1")</MudText>
                        <MudText Typo="Typo.caption">Avg Games/Player</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="6" sm="3">
                    <MudPaper Class="pa-3 text-center" Elevation="0" Style="background-color: var(--mud-palette-secondary-lighten);">
                        <MudText Typo="Typo.h5" Color="Color.Secondary">@FormatDuration(AverageMatchDuration)</MudText>
                        <MudText Typo="Typo.caption">Avg Match Duration</MudText>
                    </MudPaper>
                </MudItem>
            </MudGrid>

            <MudText Typo="Typo.subtitle2" Class="mb-2" Style="font-weight: 600;">Player Statistics</MudText>
            <MudSimpleTable Dense="true" Hover="true" Bordered="true" Style="max-height: 300px; overflow-y: auto;">
                <thead>
                    <tr>
                        <th @onclick='() => SetSortColumn("Name")' style="cursor: pointer; user-select: none;">
                            Player @GetSortIndicator("Name")
                        </th>
                        <th @onclick='() => SetSortColumn("Games")' style="text-align: center; cursor: pointer; user-select: none;">
                            Games @GetSortIndicator("Games")
                        </th>
                        <th @onclick='() => SetSortColumn("Time")' style="text-align: center; cursor: pointer; user-select: none;">
                            Time @GetSortIndicator("Time")
                        </th>
                        <th style="text-align: center; width: 2rem;"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var stat in GetSortedPlayerStats())
                    {
                        <tr>
                            <td>
                                <MudText Typo="Typo.body2" Style="white-space: nowrap;">@stat.Name</MudText>
                            </td>
                            <td style="text-align: center;">@stat.GamesPlayed</td>
                            <td style="text-align: center;">@FormatDuration(stat.PlayTime)</td>
                            <td style="text-align: center;">@(stat.IsPlaying ? "\U0001F3F8" : "\U0001FA91")</td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>
        </ChildContent>
    </MudExpansionPanel>
</MudExpansionPanels>

@code {
    [Parameter, EditorRequired] public Session Session { get; set; } = null!;
    [Parameter] public List<Match> Matches { get; set; } = new();
    [Parameter] public Dictionary<Guid, Player> PlayerLookup { get; set; } = new();

    private int CompletedMatchCount => Matches.Count(m => m.State == MatchState.Completed);

    private double AverageGamesPerPlayer
    {
        get
        {
            var activePlayers = Session.SessionPlayers.Where(sp => sp.IsActive).ToList();
            if (!activePlayers.Any()) return 0;
            var totalGames = activePlayers.Sum(sp =>
                Matches.Count(m => m.PlayerIds.Contains(sp.PlayerId)));
            return (double)totalGames / activePlayers.Count;
        }
    }

    private TimeSpan AverageMatchDuration
    {
        get
        {
            var completedMatches = Matches
                .Where(m => m.State == MatchState.Completed && m.CompletedAt.HasValue)
                .ToList();
            if (!completedMatches.Any()) return TimeSpan.Zero;
            var totalTicks = completedMatches
                .Sum(m => (m.CompletedAt!.Value - m.StartedAt).Ticks);
            return TimeSpan.FromTicks(totalTicks / completedMatches.Count);
        }
    }

    private string _sortColumn = "Games";
    private bool _sortAscending;

    private int GetInProgressCount() => Matches.Count(m => m.State == MatchState.InProgress);

    private HashSet<Guid> GetPlayingPlayerIds() => Matches
        .Where(m => m.State == MatchState.InProgress)
        .SelectMany(m => m.PlayerIds)
        .ToHashSet();

    private IEnumerable<PlayerStat> GetPlayerStats()
    {
        var playingIds = GetPlayingPlayerIds();
        var gamesPerPlayer = new Dictionary<Guid, int>();
        var timePerPlayer = new Dictionary<Guid, TimeSpan>();

        foreach (var match in Matches)
        {
            var duration = match.CompletedAt.HasValue
                ? match.CompletedAt.Value - match.StartedAt
                : (match.State == MatchState.InProgress ? DateTime.UtcNow - match.StartedAt : TimeSpan.Zero);

            foreach (var playerId in match.PlayerIds)
            {
                gamesPerPlayer.TryGetValue(playerId, out var games);
                gamesPerPlayer[playerId] = games + 1;

                timePerPlayer.TryGetValue(playerId, out var time);
                timePerPlayer[playerId] = time + duration;
            }
        }

        return Session.SessionPlayers
            .Where(sp => sp.IsActive && PlayerLookup.ContainsKey(sp.PlayerId))
            .Select(sp =>
            {
                var player = PlayerLookup[sp.PlayerId];
                gamesPerPlayer.TryGetValue(sp.PlayerId, out var games);
                timePerPlayer.TryGetValue(sp.PlayerId, out var time);

                return new PlayerStat
                {
                    Id = sp.PlayerId,
                    Name = player.Name,
                    SkillLevel = player.SkillLevel,
                    GamesPlayed = games,
                    PlayTime = time,
                    IsPlaying = playingIds.Contains(sp.PlayerId)
                };
            })
            .OrderByDescending(p => p.GamesPlayed)
            .ThenByDescending(p => p.PlayTime);
    }

    private IEnumerable<PlayerStat> GetSortedPlayerStats()
    {
        var stats = GetPlayerStats();
        return (_sortColumn, _sortAscending) switch
        {
            ("Name", false) => stats.OrderByDescending(s => s.Name),
            ("Name", true) => stats.OrderBy(s => s.Name),
            ("Games", false) => stats.OrderByDescending(s => s.GamesPlayed).ThenByDescending(s => s.PlayTime),
            ("Games", true) => stats.OrderBy(s => s.GamesPlayed).ThenBy(s => s.PlayTime),
            ("Time", false) => stats.OrderByDescending(s => s.PlayTime).ThenByDescending(s => s.GamesPlayed),
            ("Time", true) => stats.OrderBy(s => s.PlayTime).ThenBy(s => s.GamesPlayed),
            _ => stats
        };
    }

    private void SetSortColumn(string column)
    {
        if (_sortColumn == column)
        {
            _sortAscending = !_sortAscending;
        }
        else
        {
            _sortColumn = column;
            _sortAscending = false;
        }
    }

    private string GetSortIndicator(string column)
    {
        if (_sortColumn != column) return "";
        return _sortAscending ? "\u25B2" : "\u25BC";
    }

    private string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalHours >= 1)
            return $"{(int)duration.TotalHours}h {duration.Minutes}m";
        if (duration.TotalMinutes >= 1)
            return $"{(int)duration.TotalMinutes}m";
        return "< 1m";
    }

    private class PlayerStat
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public int SkillLevel { get; set; }
        public int GamesPlayed { get; set; }
        public TimeSpan PlayTime { get; set; }
        public bool IsPlaying { get; set; }
    }
}
