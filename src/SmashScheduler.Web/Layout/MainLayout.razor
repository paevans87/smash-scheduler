@inject IBreadcrumbService BreadcrumbService
@inject IThemeService ThemeService
@inject IJSRuntime JSRuntime
@using SmashScheduler.Web.Services
@using SmashScheduler.Web.Themes
@implements IAsyncDisposable
@inherits LayoutComponentBase

<MudThemeProvider @ref="_mudThemeProvider" Theme="SmashSchedulerTheme.Theme" IsDarkMode="_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="0" Class="smash-app-bar">
        <MudIconButton Icon="@Icons.Material.Filled.SportsTennis"
                       Color="Color.Primary"
                       Size="Size.Large"
                       Href="/" />
        <MudText Typo="Typo.h6" Class="ml-2">SmashScheduler</MudText>
        <MudSpacer />
        <MudMenu Icon="@GetThemeIcon()" Color="Color.Inherit" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
            <MudMenuItem Icon="@Icons.Material.Filled.SettingsBrightness" OnClick="@(() => SetTheme(ThemeMode.System))">
                @if (ThemeService.CurrentMode == ThemeMode.System)
                {
                    <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Class="mr-2" />
                }
                Use System
            </MudMenuItem>
            <MudMenuItem Icon="@Icons.Material.Filled.LightMode" OnClick="@(() => SetTheme(ThemeMode.Light))">
                @if (ThemeService.CurrentMode == ThemeMode.Light)
                {
                    <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Class="mr-2" />
                }
                Light
            </MudMenuItem>
            <MudMenuItem Icon="@Icons.Material.Filled.DarkMode" OnClick="@(() => SetTheme(ThemeMode.Dark))">
                @if (ThemeService.CurrentMode == ThemeMode.Dark)
                {
                    <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Class="mr-2" />
                }
                Dark
            </MudMenuItem>
        </MudMenu>
    </MudAppBar>
    <MudMainContent Class="smash-main-content">
        <MudContainer MaxWidth="MaxWidth.Large">
            @if (_items.Any())
            {
                <MudBreadcrumbs Items="_items" />
            }
            
        </MudContainer>
        <MudContainer MaxWidth="MaxWidth.Large">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private List<BreadcrumbItem> _items = new();
    private MudThemeProvider _mudThemeProvider = null!;
    private bool _isDarkMode;

    protected override void OnInitialized()
    {
        _items = BreadcrumbService.Items;
        _isDarkMode = ThemeService.IsDarkMode;

        BreadcrumbService.OnChange += HandleBreadcrumbsChanged;
        ThemeService.OnChange += HandleThemeChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var systemPreference = await _mudThemeProvider.GetSystemDarkModeAsync();
            ThemeService.SetSystemPreference(systemPreference);
            _isDarkMode = ThemeService.IsDarkMode;
            StateHasChanged();

            await _mudThemeProvider.WatchSystemDarkModeAsync(OnSystemPreferenceChanged);
        }
    }

    private Task OnSystemPreferenceChanged(bool prefersDark)
    {
        ThemeService.SetSystemPreference(prefersDark);
        return Task.CompletedTask;
    }

    private void HandleBreadcrumbsChanged()
    {
        InvokeAsync(() =>
        {
            _items = BreadcrumbService.Items;
            StateHasChanged();
        });
    }

    private void HandleThemeChanged()
    {
        InvokeAsync(() =>
        {
            _isDarkMode = ThemeService.IsDarkMode;
            StateHasChanged();
        });
    }

    private void SetTheme(ThemeMode mode)
    {
        ThemeService.SetThemeMode(mode);
    }

    private string GetThemeIcon() => ThemeService.CurrentMode switch
    {
        ThemeMode.Light => Icons.Material.Filled.LightMode,
        ThemeMode.Dark => Icons.Material.Filled.DarkMode,
        ThemeMode.System => Icons.Material.Filled.SettingsBrightness,
        _ => Icons.Material.Filled.SettingsBrightness
    };

    public async ValueTask DisposeAsync()
    {
        BreadcrumbService.OnChange -= HandleBreadcrumbsChanged;
        ThemeService.OnChange -= HandleThemeChanged;
    }
}